<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>一週班表（RWD＋手勢抽屜｜支援可編輯）</title>
<style>
  :root{
    --bg:#f3f4f6; --card:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb;
    --accent:#2563eb; --accent-2:#1d4ed8; --shadow:0 1px 4px rgba(0,0,0,.06);
    --scrim: rgba(0,0,0,.4);
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg:#0b0f14; --card:#121721; --text:#e5e7eb; --muted:#9aa4b2; --border:#1f2733;
      --accent:#3b82f6; --accent-2:#2563eb; --shadow:0 1px 4px rgba(0,0,0,.35);
      --scrim: rgba(0,0,0,.6);
    }
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{font-family:"Microsoft JhengHei","Noto Sans TC",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text)}

  /* 置頂工具列（sticky） */
  header{position:sticky;top:0;z-index:50;display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:#1f2937;color:#fff}
  header h1{font-size:18px;margin:0}
  .weekbar{display:flex;gap:8px;align-items:center}
  .weekbar button{padding:8px 12px;font-size:14px;border:none;border-radius:8px;background:#374151;color:#fff;cursor:pointer;touch-action:manipulation}
  .weekbar button:active{transform:translateY(1px)}
  .weekbar button:hover{background:#4b5563}
  #weekLabel{font-size:14px;opacity:.9}

  /* 版面 */
  .container{display:grid;grid-template-columns:1fr;grid-template-rows:auto auto;grid-template-areas:"cal" "panel"}
  .grid{grid-area:cal;display:grid;gap:12px;padding:12px 14px}

  /* 日期卡片 */
  .day{
    background:var(--card);border-radius:12px;border:1px solid var(--border);
    box-shadow:var(--shadow);padding:8px;min-height:72px;display:flex;flex-direction:column;cursor:pointer;
    transition:background .15s ease,border-color .15s ease;
  }
  .day:hover{background:rgba(148,163,184,.12)}
  .day .date{
    font-size:13px;font-weight:700;color:var(--text);
    background:rgba(148,163,184,.18);border:1px solid var(--border);
    border-radius:8px;padding:4px 8px;margin-bottom:6px;display:inline-block;
  }

  /* 卡片摘要：多行、兩欄 */
  .day .summary{white-space:normal;overflow:visible;text-overflow:initial;font-size:12px;color:#374151}
  @media (prefers-color-scheme: dark){ .day .summary{color:#cbd5e1} }
  .sumgrid{display:flex;flex-direction:column;gap:4px}
  .srow{display:grid;grid-template-columns:54px 1fr;align-items:start;column-gap:6px;line-height:1.35}
  .srow .k{color:var(--muted);font-weight:700}
  .srow .v{color:var(--text)}

  /* 桌機面板（小螢幕隱藏） */
  .side{grid-area:panel;border-left:none;border-top:1px solid var(--border);background:var(--card);padding:14px 14px 18px;box-shadow:0 -4px 16px rgba(0,0,0,.06)}
  .side h2{margin:0 0 12px;font-size:17px}
  .areas{display:flex;flex-wrap:wrap;gap:10px}
  .areas label{display:flex;gap:8px;align-items:center;padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:rgba(148,163,184,.12);font-size:14px;cursor:pointer}
  .areas input[type="checkbox"]{width:18px;height:18px}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
  .chip{border:1px solid var(--border);border-radius:20px;padding:6px 12px;background:rgba(148,163,184,.12);font-size:14px;display:inline-flex;gap:8px;align-items:center}
  .chip input{width:18px;height:18px}
  .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .btns button{padding:10px 14px;border:none;border-radius:10px;background:var(--accent);color:#fff;font-size:14px;cursor:pointer;touch-action:manipulation}
  .btns button:hover{background:var(--accent-2)}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid var(--border);padding:10px;text-align:center;font-size:15px}
  th{background:rgba(148,163,184,.18);font-weight:700}

  /* 彈出名單（點名字即換人） */
  td.editable{cursor:pointer}
  td.editable:hover{background:rgba(148,163,184,.12)}
  .dropdown{position:relative}
  .picker{
    position:absolute;z-index:1000;background:var(--card);border:1px solid var(--border);
    border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);padding:10px;min-width:240px;max-height:55vh;overflow:auto;right:0;
  }
  .picker .row{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:8px}
  .picker .row:hover{background:rgba(148,163,184,.16)}
  .picker .row.disabled{opacity:.45;pointer-events:none}
  .picker .hint{font-size:12px;color:var(--muted);margin:0 2px 8px}
  .picker .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
  .picker .actions button{padding:8px 10px;border:none;border-radius:8px;cursor:pointer;background:rgba(148,163,184,.18);color:var(--text)}

  /* RWD 欄數 */
  @media (min-width:360px){ .grid{grid-template-columns:repeat(1,1fr)} }
  @media (min-width:600px){ .grid{grid-template-columns:repeat(2,1fr)} .day{min-height:80px} }
  @media (min-width:900px){ .grid{grid-template-columns:repeat(4,1fr)} }
  @media (min-width:1280px){ .grid{grid-template-columns:repeat(7,1fr)} }

  /* 小螢幕：桌機面板隱藏，改用抽屜 */
  @media (max-width:899px){
    .side{display:none}
  }

  /* FAB */
  .fab{
    position:fixed;right:16px;bottom:16px;z-index:80;border:none;border-radius:999px;
    padding:12px 16px;background:var(--accent);color:#fff;font-size:14px;box-shadow:0 8px 20px rgba(0,0,0,.25);display:none;
  }
  @media (max-width:899px){ .fab{display:block} }

  /* 抽屜（手勢） */
  .scrim{
    position:fixed;inset:0;background:var(--scrim);opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:70;
  }
  .scrim.show{opacity:1;pointer-events:auto}
  .drawer{
    position:fixed;left:0;right:0;bottom:0;background:var(--card);border-top:1px solid var(--border);
    box-shadow:0 -16px 30px rgba(0,0,0,.3);padding:8px 14px 24px;z-index:75;
    transform:translateY(100%);transition:transform .25s ease;
    touch-action:none;
  }
  .drawer.open{ transform:translateY(0) }
  .drawer .handleWrap{display:flex;justify-content:center;align-items:center;padding:6px 0 8px;cursor:grab}
  .drawer .handle{width:44px;height:5px;background:rgba(148,163,184,.5);border-radius:999px}
  .drawer h2{margin:0 0 10px;font-size:16px}
</style>
</head>
<body>
<header>
  <h1>一週班表</h1>
  <div class="weekbar">
    <button id="prevWeek">← 上一週</button>
    <div id="weekLabel"></div>
    <button id="nextWeek">下一週 →</button>
  </div>
</header>

<div class="container">
  <div class="grid" id="grid"></div>

  <!-- 桌機版面板 -->
  <aside class="side" id="side">
    <h2 id="panelTitle">請從上方選日期</h2>
    <div id="panel" style="display:none">
      <div class="areas" id="areaControls"></div>
      <div style="margin:10px 0">
        <label style="display:inline-flex;gap:8px;align-items:center">
          <input type="checkbox" id="abfHelper"> ABF 小幫手
        </label>
      </div>
      <div class="chips" id="peopleChips"></div>
      <div style="color:var(--muted);font-size:12px;margin-top:6px">勾選 = 請假</div>
      <div class="btns">
        <button id="run">⚡ 自動排班（此日）</button>
        <button id="clearResults">清空結果</button>
        <button id="saveOnly">只存請假/開機</button>
      </div>
      <table>
        <thead><tr><th>工作區域</th><th>人員</th></tr></thead>
        <tbody id="resultBody"></tbody>
      </table>
    </div>
  </aside>
</div>

<!-- 手機：手勢抽屜 -->
<button class="fab" id="fab">設定 / 排班</button>
<div class="scrim" id="scrim"></div>
<div class="drawer" id="drawer" aria-modal="true" role="dialog">
  <div class="handleWrap" id="dragHandle"><div class="handle"></div></div>
  <h2 id="mPanelTitle" style="margin:0 0 10px;font-size:16px">設定</h2>
  <div id="mPanel">
    <div class="areas" id="mAreaControls"></div>
    <div style="margin:10px 0">
      <label style="display:inline-flex;gap:8px;align-items:center">
        <input type="checkbox" id="mAbfHelper"> ABF 小幫手
      </label>
    </div>
    <div class="chips" id="mPeopleChips"></div>
    <div style="color:var(--muted);font-size:12px;margin-top:6px">勾選 = 請假</div>
    <div class="btns">
      <button id="mRun">⚡ 自動排班（此日）</button>
      <button id="mClearResults">清空結果</button>
      <button id="mSaveOnly">只存請假/開機</button>
    </div>
    <table>
      <thead><tr><th>工作區域</th><th>人員</th></tr></thead>
      <tbody id="mResultBody"></tbody>
    </table>
  </div>
</div>

<script>
/* ========= 常數與資料 ========= */
const LS_KEY = "weekly_scheduler_rwd_gestures_support_edit_v1";
const PEOPLE = ["佳雯","盈儒","忻潔","阿美","美琪","小瑰","靜媚","韶湄","汶倩","麗凰","奕瑄","小雯","惠玲"];
const AREAS_WITH_CHECK = ["ABF","CDJ","MNO","PQR","GH"];
const AREAS_FIXED = ["粗篩","洗球","支援","請假"];
const ALL_AREAS = [...AREAS_WITH_CHECK, ...AREAS_FIXED, "未分派"];

/* 限制規則 */
const CANNOT = { "洗球": new Set(["阿美","佳雯","靜媚"]), "粗篩": new Set(["靜媚"]) };
const ALLOW_ONLY = { "美琪": new Set(["ABF","helper","洗球"]) };

/* TOMOE / D3I 限制 */
const TOMOE_ALLOWED = new Set(["佳雯","惠玲"]);
const D3I_ALLOWED   = new Set(["美琪","佳雯","惠玲"]);

/* ========= 小工具 ========= */
const fmt = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
function weekRange(anchor){ const d=new Date(anchor); const day=(d.getDay()+6)%7; d.setDate(d.getDate()-day); return Array.from({length:7},(_,i)=>{const x=new Date(d); x.setDate(d.getDate()+i); return x;}); }
function load(){ try{return JSON.parse(localStorage.getItem(LS_KEY)||"{}")}catch{return{}} }
function save(s){ localStorage.setItem(LS_KEY, JSON.stringify(s)); }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function intersectSets(a,b){ const out=new Set(); for(const v of a){ if(b.has(v)) out.add(v); } return out; }

/* ========= 摘要（固定順序＋未開機不顯示） ========= */
function buildSummary(dayData){
  const res = (dayData && dayData.results) || {};
  const checked = (dayData && dayData.checked) || {};
  const order = ["ABF","CDJ","MNO","PQR","GH","粗篩","洗球","支援","請假"];
  const rows = order.map(area=>{
    const arr = res[area] || [];
    if (["ABF","CDJ","MNO","PQR","GH"].includes(area) && !(checked||{})[area]) return "";
    if (!arr.length) return "";
    const val = (area === "洗球")
      ? (arr.length>4 ? `${arr.slice(0,4).join("、")} 等 +${arr.length-4}` : arr.join("、"))
      : arr.join("、");
    return `<div class="srow"><div class="k">${area}</div><div class="v">${val}</div></div>`;
  }).filter(Boolean);
  return rows.length ? `<div class="sumgrid">${rows.join("")}</div>` : "（尚未排班）";
}

/* ========= 週格 ========= */
let currentMonday = weekRange(new Date())[0];
const grid = document.getElementById("grid");
const weekLabel = document.getElementById("weekLabel");
document.getElementById("prevWeek").onclick = ()=>{ currentMonday.setDate(currentMonday.getDate()-7); renderWeek(); };
document.getElementById("nextWeek").onclick = ()=>{ currentMonday.setDate(currentMonday.getDate()+7); renderWeek(); };

function renderWeek(){
  const days = weekRange(currentMonday);
  weekLabel.textContent = `${fmt(days[0])} ～ ${fmt(days[6])}`;
  grid.innerHTML="";
  const store = load();

  days.forEach(d=>{
    const key = fmt(d);
    const card = document.createElement("div");
    card.className="day";
    card.onclick = ()=> openDay(key);
    const title = document.createElement("div");
    title.className="date";
    title.textContent = key;
    const sum = document.createElement("div");
    sum.className="summary";
    const dayData = store[key]||{};
    const hasAny = dayData.results && Object.values(dayData.results).some(v => Array.isArray(v) && v.length);
    sum.innerHTML = hasAny ? buildSummary(dayData) : "（尚未排班）";
    card.append(title,sum);
    grid.append(card);
  });
}

/* ========= 面板（桌機 + 手機抽屜共用） ========= */
const panel = document.getElementById("panel");
const panelTitle = document.getElementById("panelTitle");
const peopleChips = document.getElementById("peopleChips");
const resultBody = document.getElementById("resultBody");
const areaControls = document.getElementById("areaControls");

const mPanelTitle = document.getElementById("mPanelTitle");
const mPeopleChips = document.getElementById("mPeopleChips");
const mResultBody = document.getElementById("mResultBody");
const mAreaControls = document.getElementById("mAreaControls");

let activeDate = null;

function bindSharedControls(rootIdPrefix){
  const areaRoot = rootIdPrefix === "m" ? mAreaControls : areaControls;
  areaRoot.innerHTML = "";
  AREAS_WITH_CHECK.forEach(area=>{
    const wrap = document.createElement("label");
    Object.assign(wrap.style,{display:"flex",alignItems:"center",gap:"8px",padding:"8px 12px"});
    const cb = document.createElement("input"); cb.type="checkbox"; cb.dataset.area=area;
    const nameNode = document.createTextNode(area);

    const tomoeBox = document.createElement("span"); tomoeBox.className="optBox";
    const tomoeCb = document.createElement("input"); tomoeCb.type="checkbox"; tomoeCb.dataset.tomoe=area;
    tomoeBox.append(tomoeCb, document.createTextNode("TOMOE"));

    const d3iBox = document.createElement("span"); d3iBox.className="optBox";
    const d3iCb = document.createElement("input"); d3iCb.type="checkbox"; d3iCb.dataset.d3i=area;
    d3iBox.append(d3iCb, document.createTextNode("D3I"));
    if(area!=="ABF") d3iBox.style.display="none";

    cb.addEventListener("change", ()=>{
      if(!activeDate) return;
      const store=load(); const day=store[activeDate]||{};
      day.checked=day.checked||{}; day.checked[area]=cb.checked;
      if(!cb.checked){
        tomoeCb.checked=false; d3iCb.checked=false;
        day.tomoe = day.tomoe || {}; day.tomoe[area]=false;
        day.d3i   = day.d3i   || {}; day.d3i[area]=false;
      }
      store[activeDate]=day; save(store);
      syncControls(); renderWeek();
    });
    tomoeCb.addEventListener("change", ()=>{ if(!activeDate) return; const s=load(); const d=s[activeDate]||{}; d.tomoe=d.tomoe||{}; d.tomoe[area]=tomoeCb.checked; s[activeDate]=d; save(s); });
    d3iCb.addEventListener("change", ()=>{ if(!activeDate) return; const s=load(); const d=s[activeDate]||{}; d.d3i=d.d3i||{}; d.d3i[area]=d3iCb.checked; s[activeDate]=d; save(s); });

    wrap.append(cb, nameNode, tomoeBox, d3iBox);
    areaRoot.append(wrap);
  });
}
function syncControls(){
  const store = load(); const day = store[activeDate]||{};
  const leave = new Set(day.leave||[]);
  const checked = day.checked||{}; const tomoe=day.tomoe||{}; const d3i=day.d3i||{};
  const abfHelper = !!day.abfHelper;

  document.querySelectorAll('[data-area]').forEach(el=>{
    const area = el.dataset.area; el.checked = !!checked[area];
    const t = el.parentElement.querySelector('[data-tomoe]'); if(t){ t.checked = !!tomoe[area]; t.parentElement.style.display = el.checked ? "inline-flex":"none"; }
    const d3 = el.parentElement.querySelector('[data-d3i]'); if(d3){ d3.checked = !!d3i[area]; d3.parentElement.style.display = (el.checked && area==="ABF") ? "inline-flex":"none"; }
  });
  const abfId = document.getElementById("abfHelper"); if(abfId) abfId.checked = abfHelper;
  const mabfId = document.getElementById("mAbfHelper"); if(mabfId) mabfId.checked = abfHelper;

  peopleChips.innerHTML=""; mPeopleChips.innerHTML="";
  const addChip = (root, name)=>{
    const label = document.createElement("label"); label.className="chip";
    const cb=document.createElement("input"); cb.type="checkbox"; cb.checked=leave.has(name);
    cb.onchange = ()=>{ if(cb.checked) leave.add(name); else leave.delete(name); persistDay({leave:[...leave]}); };
    label.append(cb, document.createTextNode(" "+name)); root.append(label);
  };
  PEOPLE.forEach(n=>{ addChip(peopleChips,n); addChip(mPeopleChips,n); });

  drawResults(day.results||{}, day.manualLocks||{}, resultBody);
  drawResults(day.results||{}, day.manualLocks||{}, mResultBody);
}

function openDay(key){
  activeDate = key;
  panelTitle.textContent = `設定：${key}`;
  mPanelTitle.textContent = `設定：${key}`;
  document.getElementById("panel").style.display = "";
  const store = load(); if(!store[key]){ store[key]={}; save(store); }
  syncControls();
}

/* ========= 規則引擎 ========= */
function canAssign(name, area){
  if (ALLOW_ONLY[name]) return ALLOW_ONLY[name].has(area);
  if (CANNOT[area] && CANNOT[area].has(name)) return false;
  return true;
}

/* 穩定 pickOne（按排班會動） */
function pickOne(pool, area, allowSet=null){
  let cands = pool.map((n,i)=>({n,i})).filter(x => canAssign(x.n, area));
  if (allowSet) cands = cands.filter(x => allowSet.has(x.n));
  if (!cands.length) return null;
  const idx = Math.floor(Math.random() * cands.length);
  const pick = cands[idx];      // { n, i }
  pool.splice(pick.i, 1);       // 從原始 pool 移除
  return pick.n;
}

function coreForDate(dateStr){
  const d = new Date(dateStr);
  return (d.getDate() % 2 === 1) ? "佳雯" : "阿美";
}
function allowedSetFor(area, tomoe, d3i){
  if(area === "ABF"){
    const tOn = !!tomoe["ABF"];
    const dOn = !!d3i["ABF"];
    if(tOn && dOn) return intersectSets(TOMOE_ALLOWED, D3I_ALLOWED);
    if(tOn) return TOMOE_ALLOWED;
    if(dOn) return D3I_ALLOWED;
    return null;
  }else{
    if(!!tomoe[area]) return TOMOE_ALLOWED;
    return null;
  }
}
function canAssignToArea(name, area, tomoe, d3i){
  if(!canAssign(name, area)) return false;
  const allow = allowedSetFor(area, tomoe, d3i);
  return allow ? allow.has(name) : true;
}

/* —— 依「鎖定名單」重新排 —— */
function recomputeWithLocks(key){
  const store = load();
  const day = store[key] || {};
  const checked = day.checked || {};
  const tomoe = day.tomoe || {};
  const d3i   = day.d3i   || {};
  const abfHelperOn = !!day.abfHelper;
  const leaveSet = new Set(day.leave || []);
  const manualLocks = day.manualLocks || {};

  let lockedAll = [];
  Object.values(manualLocks).forEach(arr=>{ if(Array.isArray(arr)) lockedAll.push(...arr); });
  const lockedSet = new Set(lockedAll);
  let pool = shuffle(PEOPLE.filter(n=>!leaveSet.has(n) && !lockedSet.has(n)));

  const results = {};
  const set = (area, arr)=>{ results[area] = (arr && arr.length)? arr.slice():[]; };

  set("支援", []);
  set("請假", [...leaveSet]);

  // 先放入鎖定（✅ 不再忽略「支援」，並移出 pool）
  for (const area of ALL_AREAS) {
    const lock = manualLocks[area];
    if (!lock || !lock.length) continue;
    const good = [];
    for (const name of lock) {
      if (area==="請假"||area==="未分派") continue; // 支援不跳過
      if (!canAssignToArea(name, area, tomoe, d3i)) continue;
      if (leaveSet.has(name)) continue;
      good.push(name);
    }
    if (good.length) {
      set(area, good);
      // ⬇️ 把已鎖定的人從池子移除，避免被派去別區
      good.forEach(nm => { pool = pool.filter(x => x !== nm); });
    }
  }

  // 1) 粗篩：奇偶核心＋替補
  if(!(results["粗篩"] && results["粗篩"].length)){
    const bothOnLeave = leaveSet.has("佳雯") && leaveSet.has("阿美");
    if (bothOnLeave) {
      let partners = pool.map((n,i)=>({n,i})).filter(x=>canAssign(x.n,"粗篩"));
      const group = [];
      for (let k=0;k<2 && partners.length;k++){
        const pickIdx = Math.floor(Math.random()*partners.length);
        const pick = partners.splice(pickIdx,1)[0];
        group.push(pick.n);
        const rm = pool.indexOf(pick.n);
        if (rm >= 0) pool.splice(rm,1);
      }
      set("粗篩", group.length ? group : ["缺人"]);
    } else {
      let core = coreForDate(key);
      if (leaveSet.has(core)) core = (core==="佳雯") ? "阿美" : "佳雯";
      const group = [];
      const idx = pool.indexOf(core);
      if(idx>=0){ group.push(pool[idx]); pool.splice(idx,1); }
      let partners = pool.map((n,i)=>({n,i}))
        .filter(x=> x.n!=="佳雯" && x.n!=="阿美" && canAssign(x.n,"粗篩"));
      if(partners.length){
        const p = partners[Math.floor(Math.random()*partners.length)];
        group.push(p.n); pool.splice(p.i,1);
      }
      set("粗篩", group.length ? group : ["缺人"]);
    }
  }else{
    for(const n of results["粗篩"]) pool = pool.filter(x=>x!==n);
  }

  // 2) ABF / CDJ（含小幫手）
  const abfAllow = allowedSetFor("ABF", tomoe, d3i);
  const cdjAllow = allowedSetFor("CDJ", tomoe, d3i);

  const takeLocked = (area)=>{
    const lock = manualLocks[area]||[];
    if(lock.length){ set(area, lock.slice()); lock.forEach(n=>{ pool = pool.filter(x=>x!==n); }); return true; }
    return false;
  };
  const abfLocked = takeLocked("ABF");
  const cdjLocked = takeLocked("CDJ");

  if(!abfLocked || !cdjLocked){
    if(checked["ABF"] && checked["CDJ"] && abfHelperOn){
      if(!abfLocked){ const abfMain = pickOne(pool,"ABF", abfAllow); if(abfMain) set("ABF", [ ...(results["ABF"]||[]), abfMain ]); }
      if(!cdjLocked){ const cdjMain = pickOne(pool,"CDJ", cdjAllow); if(cdjMain) set("CDJ", [ ...(results["CDJ"]||[]), cdjMain ]); }
      const helper  = pickOne(pool,"helper", null);
      if(helper){
        set("ABF", [ ...(results["ABF"]||[]), `${helper}(小幫手)` ]);
        set("CDJ", [ ...(results["CDJ"]||[]), `${helper}(小幫手)` ]);
      }
    }else{
      if(checked["ABF"] && !abfLocked){ const who=pickOne(pool,"ABF", abfAllow); if(who) set("ABF", [who]); }
      if(!checked["ABF"] && !abfLocked) set("ABF", ["（未開機）"]);
      if(checked["CDJ"] && !cdjLocked){ const who=pickOne(pool,"CDJ", cdjAllow); if(who) set("CDJ", [who]); }
      if(!checked["CDJ"] && !cdjLocked) set("CDJ", ["（未開機）"]);
    }
  }

  // 3) MNO / PQR / GH（各 1）
  ["MNO","PQR","GH"].forEach(a=>{
    if(manualLocks[a] && manualLocks[a].length){
      set(a, manualLocks[a].slice());
      manualLocks[a].forEach(n=>{ pool = pool.filter(x=>x!==n); });
    }else{
      if((checked||{})[a]){ const who = pickOne(pool, a, allowedSetFor(a, tomoe, d3i)); if(who) set(a, [who]); }
      else set(a, ["（未開機）"]);
    }
  });

  // 4) 洗球（剩餘且允許；再平衡；未分派）
  if(manualLocks["洗球"] && manualLocks["洗球"].length){
    set("洗球", manualLocks["洗球"].slice());
    manualLocks["洗球"].forEach(n=>{ pool = pool.filter(x=>x!==n); });
    set("未分派", pool.slice());
  }else{
    let washList = pool.filter(n=>canAssign(n,"洗球"));
    set("洗球", washList);
    let leftovers = pool.filter(n => !canAssign(n, "洗球"));
    const adjustableAreas = ["ABF","CDJ","MNO","PQR","GH"].filter(a => (checked||{})[a]);
    for (const L of [...leftovers]) {
      for (const area of adjustableAreas) {
        const arr = results[area] || [];
        if (!arr.length) continue;
        if (!canAssignToArea(L, area, tomoe, d3i)) continue;
        const idx = arr.findIndex(S => S && !String(S).includes("(小幫手)") && canAssign(S, "洗球"));
        if (idx >= 0) {
          const S = arr[idx];
          arr[idx] = L;
          results[area] = arr.slice();
          washList = washList.concat([S]);
          set("洗球", washList);
          leftovers = leftovers.filter(x => x !== L);
          break;
        }
      }
    }
    set("未分派", leftovers);
  }

  day.results = results;
  day.manualLocks = manualLocks;
  store[key] = day; save(store);
  if(key===activeDate){ drawResults(results, manualLocks, resultBody); drawResults(results, manualLocks, mResultBody); }
  renderWeek();
}

/* ========= 自動排班 ========= */
function runForDay(key){
  const store = load(); const day = store[key] || {};
  day.manualLocks = day.manualLocks || {};
  store[key]=day; save(store);
  recomputeWithLocks(key);
}

/* ========= 結果表 + 點名字即換人 ========= */
function drawResults(results, manualLocks, tbody){
  tbody.innerHTML="";
  ALL_AREAS.forEach(a=>{
    const tr=document.createElement("tr");
    const tdA=document.createElement("td"); tdA.textContent=a;

    const tdP=document.createElement("td");
    // ✅ 支援可編輯（只有「請假」不可編輯）
    const isEditable = (a!=="請假");
    tdP.textContent = (results[a] && results[a].length) ? results[a].join("、") : "—";
    if(isEditable){
      tdP.classList.add("editable","dropdown");
      tdP.onclick = (e)=>{ e.stopPropagation(); openPicker(tdP, a, results, manualLocks); };
    }
    tr.append(tdA,tdP); tbody.append(tr);
  });
}

/* 點名字即可換人（彈窗） */
function openPicker(td, area, results, manualLocks){
  closeAnyPicker();
  const store = load();
  const day = store[activeDate] || {};
  const leaveSet = new Set(day.leave || []);
  const tomoe  = day.tomoe || {};
  const d3i    = day.d3i   || {};
  const allowSet = allowedSetFor(area, tomoe, d3i);

  const picker = document.createElement("div");
  picker.className = "picker";

  const hint = document.createElement("div");
  hint.className = "hint";
  hint.textContent = "點名字即可替換此區人員（其餘自動重排）";
  picker.append(hint);

  const SINGLE_SLOT = ["ABF","CDJ","MNO","PQR","GH"]; // 支援不是單槽，屬於可多選鎖定
  PEOPLE.forEach(name=>{
    const okByLeave = !leaveSet.has(name);
    const okByRule  = allowSet ? allowSet.has(name) : true;
    const okByArea  = canAssignToArea(name, area, tomoe, d3i);
    const enabled   = okByLeave && okByRule && okByArea;

    const row = document.createElement("div");
    row.className = "row" + (enabled ? "" : " disabled");
    row.style.cursor = enabled ? "pointer" : "default";
    const label = document.createElement("span");
    label.textContent = name + (!enabled ? "（不可選）" : "");
    row.append(label);

    if(enabled){
      row.onclick = ()=>{
        const st=load(); const d=st[activeDate]||{};
        d.manualLocks = d.manualLocks || {};
        if(SINGLE_SLOT.includes(area)){ d.manualLocks[area] = [name]; }
        else{
          const prev = Array.isArray(d.manualLocks[area]) ? d.manualLocks[area].slice() : [];
          if(!prev.includes(name)) prev.push(name);
          d.manualLocks[area] = prev;
        }
        st[activeDate]=d; save(st);
        recomputeWithLocks(activeDate);
        closeAnyPicker();
      };
    }
    picker.append(row);
  });

  const actions = document.createElement("div");
  actions.className = "actions";
  const btnClear = document.createElement("button");
  btnClear.className = "clear";
  btnClear.textContent = "清空鎖定";
  btnClear.onclick = ()=>{
    const st=load(); const d=st[activeDate]||{};
    d.manualLocks = d.manualLocks || {}; d.manualLocks[area] = [];
    st[activeDate]=d; save(st);
    recomputeWithLocks(activeDate);
    closeAnyPicker();
  };
  actions.append(btnClear);
  picker.append(actions);

  td.appendChild(picker);

  // 防止超出畫面
  const rect = picker.getBoundingClientRect();
  const vh = window.innerHeight;
  if(rect.bottom > vh) picker.style.maxHeight = (vh - rect.top - 12) + "px";

  setTimeout(()=>{
    const closer = (e)=>{
      if(!picker.contains(e.target)){ closeAnyPicker(); document.removeEventListener("mousedown", closer); }
    };
    document.addEventListener("mousedown", closer, {passive:true});
  },0);
}
function closeAnyPicker(){ document.querySelectorAll(".picker").forEach(p=>p.remove()); }

function persistDay(patch){
  if(!activeDate) return;
  const store = load();
  const day = store[activeDate] || {};
  store[activeDate] = {...day, ...patch};
  save(store);
  renderWeek();
}

/* 共用控制：小幫手 & 按鈕（含未選日期提示） */
document.getElementById("abfHelper").addEventListener('change', e=>{ if(!activeDate) return; persistDay({abfHelper:e.target.checked}); });

document.getElementById("run").onclick = ()=>{
  if (!activeDate) { alert("請先點上方某一天卡片，再按『自動排班』。"); return; }
  runForDay(activeDate);
};
document.getElementById("clearResults").onclick = ()=>{
  if(!activeDate){ alert("請先選擇日期再清空。"); return; }
  const store=load(); store[activeDate]=store[activeDate]||{}; store[activeDate].results={}; store[activeDate].manualLocks={}; save(store);
  syncControls(); renderWeek();
};
document.getElementById("saveOnly").onclick = ()=>{ if(activeDate) alert("已保存開機 / 小幫手 / TOMOE / D3I / 請假設定。"); else alert("請先選日期。"); };

/* ========= 手機抽屜（手勢） ========= */
const fab = document.getElementById("fab");
const drawer = document.getElementById("drawer");
const scrim = document.getElementById("scrim");
const dragHandle = document.getElementById("dragHandle");

let startY = 0, currentY = 0, drawerHeight = 0, dragging = false;
const OPEN_THRESHOLD = 80;
const clamp = (v,min,max)=>Math.min(max,Math.max(min,v));

function setDrawerTranslateY(px){
  drawer.style.transition = 'none';
  drawer.style.transform = `translateY(${px}px)`;
  const ratio = clamp(px / drawerHeight, 0, 1);
  scrim.style.opacity = String(1 - ratio);
}
function openDrawer(){
  drawer.classList.add('open');
  drawer.style.transition = '';
  drawer.style.transform = '';
  scrim.classList.add('show');
}
function closeDrawer(){
  drawer.classList.remove('open');
  drawer.style.transition = '';
  drawer.style.transform = '';
  scrim.classList.remove('show');
}

function onDragStart(clientY){
  dragging = true;
  const rect = drawer.getBoundingClientRect();
  drawerHeight = rect.height;
  startY = clientY;
  currentY = 0;
  if(!drawer.classList.contains('open')){
    drawer.style.transform = `translateY(${drawerHeight}px)`;
    scrim.classList.add('show');
  }
}
function onDragMove(clientY){
  if(!dragging) return;
  const delta = clientY - startY;
  const base = drawer.classList.contains('open') ? 0 : drawerHeight;
  const y = clamp(base + delta, 0, drawerHeight);
  currentY = y;
  setDrawerTranslateY(y);
}
function onDragEnd(){
  if(!dragging) return;
  drawer.style.transition = 'transform .2s ease';
  const halfway = drawerHeight / 2;
  if(drawer.classList.contains('open')){
    if(currentY > Math.max(OPEN_THRESHOLD, halfway * 0.6)){ closeDrawer(); }
    else{ openDrawer(); }
  }else{
    if(currentY < drawerHeight - Math.max(OPEN_THRESHOLD, halfway * 0.6)){ openDrawer(); }
    else{ closeDrawer(); }
  }
  dragging = false;
}

const activeArea = [drawer, dragHandle];
activeArea.forEach(el=>{
  el.addEventListener('touchstart', e=>{ onDragStart(e.touches[0].clientY); }, {passive:true});
  el.addEventListener('touchmove',  e=>{ onDragMove(e.touches[0].clientY); }, {passive:true});
  el.addEventListener('touchend',   e=>{ onDragEnd(); }, {passive:true});

  el.addEventListener('mousedown', e=>{ onDragStart(e.clientY); });
  window.addEventListener('mousemove', e=>{ if(dragging) onDragMove(e.clientY); });
  window.addEventListener('mouseup',   e=>{ if(dragging) onDragEnd(); });
});

fab.addEventListener('click', ()=>{
  if(drawer.classList.contains('open')) closeDrawer(); else openDrawer();
});
scrim.addEventListener('click', closeDrawer);

/* 手機面板按鈕（同提示） */
document.getElementById("mAbfHelper").addEventListener('change', e=>{ if(!activeDate) return; persistDay({abfHelper:e.target.checked}); });
document.getElementById("mRun").onclick = ()=>{
  if (!activeDate) { alert("請先點上方某一天卡片，再按『自動排班』。"); return; }
  runForDay(activeDate);
};
document.getElementById("mClearResults").onclick = ()=>{
  if(!activeDate){ alert("請先選擇日期再清空。"); return; }
  const store=load(); store[activeDate]=store[activeDate]||{}; store[activeDate].results={}; store[activeDate].manualLocks={}; save(store);
  syncControls(); renderWeek();
};
document.getElementById("mSaveOnly").onclick = ()=>{ if(activeDate) alert("已保存開機 / 小幫手 / TOMOE / D3I / 請假設定。"); else alert("請先選日期。"); };

/* ========= 初始化 ========= */
function buildAreaControls(rootIdPrefix){
  const areaRoot = rootIdPrefix === "m" ? mAreaControls : areaControls;
  areaRoot.innerHTML = "";
  AREAS_WITH_CHECK.forEach(area=>{
    const wrap = document.createElement("label");
    Object.assign(wrap.style,{display:"flex",alignItems:"center",gap:"8px",padding:"8px 12px"});
    const cb = document.createElement("input"); cb.type="checkbox"; cb.dataset.area=area;
    const nameNode = document.createTextNode(area);

    const tomoeBox = document.createElement("span"); tomoeBox.className="optBox";
    const tomoeCb = document.createElement("input"); tomoeCb.type="checkbox"; tomoeCb.dataset.tomoe=area;
    tomoeBox.append(tomoeCb, document.createTextNode("TOMOE"));

    const d3iBox = document.createElement("span"); d3iBox.className="optBox";
    const d3iCb = document.createElement("input"); d3iCb.type="checkbox"; d3iCb.dataset.d3i=area;
    d3iBox.append(d3iCb, document.createTextNode("D3I"));
    if(area!=="ABF") d3iBox.style.display="none";

    cb.addEventListener("change", ()=>{
      if(!activeDate) return;
      const store=load(); const day=store[activeDate]||{};
      day.checked=day.checked||{}; day.checked[area]=cb.checked;
      if(!cb.checked){
        tomoeCb.checked=false; d3iCb.checked=false;
        day.tomoe = day.tomoe || {}; day.tomoe[area]=false;
        day.d3i   = day.d3i   || {}; day.d3i[area]=false;
      }
      store[activeDate]=day; save(store);
      syncControls(); renderWeek();
    });
    tomoeCb.addEventListener("change", ()=>{ if(!activeDate) return; const s=load(); const d=s[activeDate]||{}; d.tomoe=d.tomoe||{}; d.tomoe[area]=tomoeCb.checked; s[activeDate]=d; save(s); });
    d3iCb.addEventListener("change", ()=>{ if(!activeDate) return; const s=load(); const d=s[activeDate]||{}; d.d3i=d.d3i||{}; d.d3i[area]=d3iCb.checked; s[activeDate]=d; save(s); });

    wrap.append(cb, nameNode, tomoeBox, d3iBox);
    areaRoot.append(wrap);
  });
}
buildAreaControls("");  // 桌機
buildAreaControls("m"); // 手機
renderWeek();
</script>
</body>
</html>
