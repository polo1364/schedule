<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>自動排班表</title>
<style>
body{font-family:"Microsoft JhengHei",sans-serif;margin:0;background:#f3f4f6;color:#111}
header{position:sticky;top:0;background:#1f2937;color:#fff;padding:8px;z-index:50;display:flex;flex-wrap:wrap;gap:8px;align-items:center}
header button{border:none;background:#3b82f6;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer}
header button:hover{background:#2563eb}
.weekbar{display:flex;gap:8px;align-items:center}
.grid{display:grid;gap:8px;padding:8px}
@media(min-width:600px){.grid{grid-template-columns:repeat(2,1fr)}}
@media(min-width:900px){.grid{grid-template-columns:repeat(4,1fr)}}
@media(min-width:1280px){.grid{grid-template-columns:repeat(7,1fr)}}
.day{background:#fff;border:1px solid #ddd;border-radius:8px;padding:8px;cursor:pointer}
.date{font-weight:bold;margin-bottom:4px}
.summary{font-size:12px;color:#444}
.side{padding:12px;background:#fff;border-top:1px solid #ddd}
table{width:100%;border-collapse:collapse;margin-top:8px;background:#fff}
th,td{border:1px solid #ddd;padding:6px;text-align:center}
td.editable span.name{cursor:pointer;padding:2px 4px;border-radius:4px;display:inline-block}
td.editable span.name:hover{background:#eee}
.picker{position:absolute;z-index:100;background:#fff;border:1px solid #ccc;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.2);padding:8px;max-height:50vh;overflow:auto}
.picker .row{padding:4px 8px;cursor:pointer;border-radius:6px}
.picker .row:hover{background:#eee}
.picker .row.disabled{color:#999;cursor:not-allowed}
.k{color:#6b7280;font-weight:bold}
</style>
</head>
<body>
<header>
  <div class="weekbar">
    <button id="prevWeek">← 上一週</button>
    <div id="weekLabel"></div>
    <button id="nextWeek">下一週 →</button>
  </div>
  <button id="autoWeek">⚡ 一鍵自動排整週</button>
  <button id="autoToday">⚡ 自動排當天</button>
</header>

<div class="grid" id="grid"></div>

<div class="side">
  <h2 id="panelTitle">請選日期</h2>
  <table>
    <thead><tr><th>工作區域</th><th>人員</th></tr></thead>
    <tbody id="resultBody"></tbody>
  </table>
  <div style="font-size:12px;color:#6b7280;margin-top:6px">
    小技巧：點某個名字可直接替換他；不合規的選項會顯示「不可」且無法選取。
  </div>
</div>

<script>
/* ===== 人員與區域 ===== */
const PEOPLE=["佳雯","盈儒","忻潔","阿美","美琪","小瑰","靜媚","韶湄","汶倩","麗凰","奕瑄","小雯","惠玲"];
const AREAS=["ABF","CDJ","MNO","PQR","GH","粗篩","洗球","支援","請假"];
const LS_KEY="sched_full_rules_v1";

/* 限制規則 */
const CANNOT={
  "洗球":new Set(["阿美","佳雯","靜媚"]),
  "粗篩":new Set(["靜媚"])
};
const ALLOW_ONLY={
  "美琪":new Set(["ABF","洗球","helper"])
};
const TOMOE_ALLOWED=new Set(["佳雯","惠玲"]);
const D3I_ALLOWED=new Set(["美琪","佳雯","惠玲"]);

/* 工具 */
function load(){try{return JSON.parse(localStorage.getItem(LS_KEY)||"{}")}catch{return{}}}
function save(s){localStorage.setItem(LS_KEY,JSON.stringify(s))}
function fmt(d){return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`}
function weekRange(anchor){const d=new Date(anchor);const day=(d.getDay()+6)%7;d.setDate(d.getDate()-day);return Array.from({length:7},(_,i)=>{const x=new Date(d);x.setDate(d.getDate()+i);return x;});}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}

/* 規則檢查 */
function canAssign(name,area,tomoe={},d3i={}){
  if(ALLOW_ONLY[name] && !ALLOW_ONLY[name].has(area)) return false;
  if(CANNOT[area] && CANNOT[area].has(name)) return false;
  if(area==="ABF"||area==="CDJ"){
    if(tomoe[area]){ if(!TOMOE_ALLOWED.has(name)) return false; }
    if(d3i[area]){ if(!D3I_ALLOWED.has(name)) return false; }
  }
  return true;
}

/* 畫面 */
let currentMonday=weekRange(new Date())[0];
let activeDate=null;

function buildSummary(results,checked){
  if(!results) return "（尚未排班）";
  const order=["ABF","CDJ","MNO","PQR","GH","粗篩","洗球","支援","請假"];
  const rows=order.map(a=>{
    if(checked && checked[a]===false) return "";
    const v=results[a]||[];
    if(!v.length) return "";
    const val=(a==="洗球" && v.length>4)?`${v.slice(0,4).join("、")} 等 +${v.length-4}`:v.join("、");
    return `<div><span class="k">${a}</span>：${val}</div>`;
  }).filter(Boolean);
  return rows.length?rows.join(""):"（尚未排班）";
}

function renderWeek(){
  const days=weekRange(currentMonday);const store=load();
  document.getElementById("weekLabel").textContent=`${fmt(days[0])}～${fmt(days[6])}`;
  const grid=document.getElementById("grid");grid.innerHTML="";
  days.forEach(d=>{
    const key=fmt(d);
    const card=document.createElement("div");card.className="day";card.onclick=()=>openDay(key);
    const data=store[key]||{};
    const summary=buildSummary(data.results,data.checked);
    card.innerHTML=`<div class="date">${key}</div><div class="summary">${summary}</div>`;
    grid.append(card);
  });
}
document.getElementById("prevWeek").onclick=()=>{currentMonday.setDate(currentMonday.getDate()-7);renderWeek();};
document.getElementById("nextWeek").onclick=()=>{currentMonday.setDate(currentMonday.getDate()+7);renderWeek();};

/* 打開日期 */
function openDay(key){
  activeDate=key;
  document.getElementById("panelTitle").textContent="設定："+key;
  const store=load();
  if(!store[key])store[key]={results:{},checked:{ABF:true,CDJ:true,MNO:true,PQR:true,GH:true}};
  drawResults(store[key].results,store[key].checked||{});
}

/* 畫表 */
function drawResults(results,checked){
  const tbody=document.getElementById("resultBody");tbody.innerHTML="";
  AREAS.forEach(a=>{
    if(checked[a]===false) return;
    const tr=document.createElement("tr");
    const tdA=document.createElement("td");tdA.textContent=a;
    const tdP=document.createElement("td");
    const arr=results[a]||[];
    if(arr.length){
      tdP.className="editable";
      arr.forEach((n,idx)=>{
        const span=document.createElement("span");
        span.textContent=n;
        span.className="name";
        span.onclick=(e)=>{e.stopPropagation();openPicker(tdP,a,idx,n)};
        tdP.append(span);
        if(idx<arr.length-1)tdP.append("、");
      });
    }else tdP.textContent="—";
    tr.append(tdA,tdP);tbody.append(tr);
  });
}

/* 名單替換 */
function openPicker(td,area,idx,currentName){
  closeAnyPicker();
  const store=load();const day=store[activeDate]||{};
  const tomoe=day.tomoe||{};const d3i=day.d3i||{};
  const picker=document.createElement("div");picker.className="picker";
  PEOPLE.forEach(name=>{
    const enabled=canAssign(name,area,tomoe,d3i);
    const row=document.createElement("div");
    row.className="row"+(enabled?"":" disabled");
    row.textContent=name+(name===currentName?"（目前）":(enabled?"":"（不可）"));
    if(enabled){
      row.onclick=()=>{
        const store=load();const d=store[activeDate]||{results:{}};
        d.results[area][idx]=name;
        store[activeDate]=d;save(store);
        drawResults(d.results,d.checked||{});renderWeek();closeAnyPicker();
      };
    }
    picker.append(row);
  });
  td.style.position="relative";td.append(picker);
}
function closeAnyPicker(){document.querySelectorAll(".picker").forEach(p=>p.remove());}

/* 自動排班邏輯 */
function coreByDate(dateStr){const day=new Date(dateStr).getDate();return(day%2===1)?"佳雯":"阿美";}
function autoScheduleOne(dateStr){
  const store=load();const d=store[dateStr]||{results:{},checked:{ABF:true,CDJ:true,MNO:true,PQR:true,GH:true}};
  const results={};let pool=shuffle([...PEOPLE]);
  const checked=d.checked||{};

  // 請假剔除
  const leave=new Set(d.leave||[]);
  pool=pool.filter(x=>!leave.has(x));

  // 粗篩
  const core=coreByDate(dateStr);
  const rough=[];
  if(!leave.has(core)&&canAssign(core,"粗篩")){pool=pool.filter(x=>x!==core);rough.push(core);}
  const partner=pool.find(n=>canAssign(n,"粗篩")&&n!=="佳雯"&&n!=="阿美");
  if(partner){pool=pool.filter(x=>x!==partner);rough.push(partner);}
  results["粗篩"]=rough;

  // ABF/CDJ
  if(checked.ABF){const who=pool.find(n=>canAssign(n,"ABF",d.tomoe,d.d3i));if(who){pool=pool.filter(x=>x!==who);results["ABF"]=[who];}}
  if(checked.CDJ){const who=pool.find(n=>canAssign(n,"CDJ",d.tomoe,d.d3i));if(who){pool=pool.filter(x=>x!==who);results["CDJ"]=[who];}}

  // MNO/PQR/GH
  ["MNO","PQR","GH"].forEach(a=>{
    if(checked[a]){const who=pool.find(n=>canAssign(n,a));if(who){pool=pool.filter(x=>x!==who);results[a]=[who];}}
  });

  // 洗球
  results["洗球"]=pool.filter(n=>canAssign(n,"洗球"));
  results["支援"]=results["支援"]||[];
  results["請假"]=[...leave];

  d.results=results;store[dateStr]=d;save(store);
  if(activeDate===dateStr){drawResults(results,d.checked);}
}

function autoScheduleWeek(){weekRange(currentMonday).forEach(d=>autoScheduleOne(fmt(d)));renderWeek();}
document.getElementById("autoWeek").onclick=autoScheduleWeek;
document.getElementById("autoToday").onclick=()=>{
  if(!activeDate){alert("請先選一天");return;}
  autoScheduleOne(activeDate);renderWeek();
};

/* 初始化 */
renderWeek();
</script>
</body>
</html>
